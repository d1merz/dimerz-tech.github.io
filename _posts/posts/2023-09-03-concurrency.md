---
layout: post
title: "Concurrency –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ Rust Tokio"
date: 2023-09-03 20:28:39 +0300
categories: [posts, linux, rust]
---

![concurrency](../../images/posts/concurrency/epoll.png)

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º, —Ä–∞–±–æ—Ç–∞—é—â–∏–º —Å –±–æ–ª—å—à–∏–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö, UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏, —Å–µ—Ç–µ–≤—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–∂–∏–¥–∞—Ç—å 
–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å–æ–±—ã—Ç–∏–π. –í —ç—Ç–æ–º –≤—Ä–µ–º—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –∂–¥–∞—Ç—å –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è 
—Ç–µ—Ö –∏–ª–∏ –∏–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π. 

![concurrency](../../images/posts/concurrency/wQvYdj8UNDn0Klz77JbmUw_store_header_image.png)

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è
* üíé **–ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —è–¥–µ—Ä**
* ‚õìÔ∏è **–ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ (threads)**
* ‚ôªÔ∏è **–ú—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ**

–í—Å–µ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ–∂–¥—É —Å–æ–±–æ–π.

## Concurrency vs Multithreading
![concurrency](../../images/posts/concurrency/nginx-vs-apache.png)
–ü–æ—Ç–æ–∫ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–∞–º—è—Ç–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–∞—è —Å—É—â–Ω–æ—Å—Ç—å. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ –Ω–∞ –æ–¥–Ω–æ–º
—è–¥—Ä–µ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ —Ç–∞–∫—Ç–æ–≤, –ø–æ—ç—Ç–æ–º—É, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤ = —á–∏—Å–ª—É —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —è–¥–µ—Ä. 
–¢–∞–∫ —Ä–∞–±–æ—Ç–∞–ª `Apache`. –û–Ω –ø–æ—è–≤–∏–ª—Å—è –æ—á–µ–Ω—å –¥–∞–≤–Ω–æ, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä–∞ –±—ã–ª–∏ –Ω–µ —Ç–∞–∫–∏–º–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏, –æ–¥–Ω–∞–∫–æ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ—è–≤–∏–ª–∞—Å—å
[–ø—Ä–æ–±–ª–µ–º–∞ 10-—Ç–∏ —Ç—ã—Å—è—á —Å–æ–µ–¥–∏–Ω–µ–∏–π](https://en.wikipedia.org/wiki/C10k_problem). –ö–∞–∫ —Ä–µ—à–∞—Ç—å —Ç–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É? –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è 
–∑–∞ —Å—á–µ—Ç –∂–µ–ª–µ–∑–∞, —á—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ—Ä–æ–≥–æ. `Nginx` –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å–≤–æ–π –ø–æ–¥—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª–∏–ª —Å–æ–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ä—ã–≤. –ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

* **worker_processes** ‚Äì The number of NGINX worker processes (the default is 1). 
  In most cases, running one worker process per CPU core works well, and we recommend setting this directive to auto to achieve that. 
  There are times when you may want to increase this number, such as when the worker processes have to do a lot of disk I/O.
* **worker_connections** ‚Äì The maximum number of connections that each worker process can handle simultaneously. 
  The default is 512, but most systems have enough resources to support a larger number. 
  The appropriate setting depends on the size of the server and the nature of the traffic, and can be discovered through testing.

–¢–æ –µ—Å—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –æ–¥–Ω–æ–º —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —è–¥—Ä–µ —Ä–∞–≤–Ω–æ 512. –ü–æ–¥—á–µ—Ä–∫–Ω—É, <ins>–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ</ins>. –ï—Å–ª–∏ –º—ã –≤–æ–∑—å–º–µ–º —Å–µ—Ä–≤–µ—Ä
–≤—Ä–æ–¥–µ Intel Xeon —Å 32 —è–¥—Ä–∞–º–∏, —Ç–æ –≤ —Å–∞–º–æ–º —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º—ã —Å–º–æ–∂–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–æ–ª–µ–µ 16–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ.
–ö–∞–∫ Nginx –¥–æ–±–∏–ª—Å—è —Ç–∞–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ? –ë–ª–∞–≥–æ–¥–∞—Ä—è `concurrency` –ø–æ–¥—Ö–æ–¥—É.

### Multiplexing
–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏, –≥–¥–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞, –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ–ª–µ–µ
—Ö–∏—Ç—Ä–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –æ–¥–Ω–æ–≥–æ —è–¥—Ä–∞ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–ª—é–∑–∏—é –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
![concurrency](../../images/posts/concurrency/6574.1623908671.jpg)

–í —Å–ª—É—á–∞–µ —Å Nginx —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –º–æ–¥—É–ª—å —è–¥—Ä–∞ [epoll](https://man7.org/linux/man-pages/man7/epoll.7.html). –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –µ–≥–æ —Ä–∞–±–æ—Ç—ã
–∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ—Å–∏—Ç—å —è–¥—Ä–æ —Ä–∞–∑–±—É–¥–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –∫–∞–∫–æ–µ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –¥–ª—è –Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏–µ. –°–∞–º –ø–æ —Å–µ–±–µ –≤—ã–∑–æ–≤ 
`epoll_wait()` —è–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫–∏—Ä—É—é—â–∏–º. –û—á–µ–Ω—å –≤–∫—Ä–∞—Ç—Ü–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

* **level-triggered**
* **edge-triggered**

–¢–∞–∫–∂–µ –µ—Å—Ç—å 2 –≤–∏–¥–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤:

* **blocking**
* **non-blocking**

–û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –≤–∫—Ä–∞—Ç—Ü–µ:

* –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π `read()\write()` –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç `thread` –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–∏ –≤ `blocking fd`
* –í —Å–ª—É—á–∞–µ `non-blocking fd` –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π `read()\write()` –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç `thread`, –∞ —Å—Ä–∞–∑—É –∂–µ –≤–µ—Ä–Ω–µ—Ç control flow, 
  –¥–∞–∂–µ –µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –±—ã–ª–æ –Ω–µ—á–µ–≥–æ
* `epoll` —Å `level-triggered` —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –±—É–¥–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã 
  (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –Ω–∏—Ö –µ—Å—Ç—å `data`). –ü—Ä–∏ —ç—Ç–æ–º –≤—ã–∑–æ–≤ `epoll_wait` –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
  –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π (–¥–∞–Ω–Ω—ã—Ö) –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç `thread`. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ —Å–æ–∫–µ—Ç–∞, –µ—Å–ª–∏ –≤ —Å–æ–∫–µ—Ç–µ –æ—Å—Ç–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ, `epoll` –±—É–¥–µ—Ç
  —Å–Ω–æ–≤–∞ –∏ —Å–Ω–æ–≤–∞ (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ) —Å–æ–æ–±—â–∞—Ç—å –Ω–∞–º –æ–± —ç—Ç–æ–º. 
* `epoll` —Å `edge-triggered` —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –±—É–¥–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –µ–¥–∏–Ω–æ–∂–¥—ã –ø–æ —Å–æ–±—ã—Ç–∏—é. –ï—Å–ª–∏ –º—ã –Ω–µ –¥–æ—á–∏—Ç–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–∫–µ—Ç–∞,
  –æ—á–µ—Ä–µ–¥–Ω–æ–π –≤—ã–∑–æ–≤ `epoll_wait` –±—É–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å, –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥–µ—Ç –Ω–æ–≤–∞—è –ø–æ—Ä—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö. –î–∞–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
  —Ç–æ–ª—å–∫–æ —Å –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º–∏ —Å–æ–∫–µ—Ç–∞–º–∏, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –∂–µ –≤–µ—Ä–Ω—É—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

## Async/await –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ Tokio
–°–∫–æ—Ä–æ –±—É–¥–µ—Ç...


## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏
* [–ü—Ä–æ Nginx](https://www.nginx.com/blog/tuning-nginx/)
* [Apache vs Nginx](https://gohost.kz/blog/hosting/chto-luchshe-nginx-vs-apache/)
* [–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø—Ä–æ epoll](https://habr.com/ru/articles/416669/)